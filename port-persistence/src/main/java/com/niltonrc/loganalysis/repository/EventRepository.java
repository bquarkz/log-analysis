package com.niltonrc.loganalysis.repository;

import com.niltonrc.loganalysis.constants.DBConstants;
import com.niltonrc.loganalysis.contract.IEventRepository;
import com.niltonrc.loganalysis.entities.event.EventEntity;
import com.niltonrc.loganalysis.utils.DBUtils;
import com.niltonrc.loganalysis.utils.LogPrinter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

import javax.sql.DataSource;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.List;

@Repository
public class EventRepository
    implements IEventRepository
{
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Constants
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    private static final Logger LOGGER = LoggerFactory.getLogger( EventRepository.class );

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Special Fields And Injections
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    private final LogPrinter logPrinter;
    private final DataSource dataSource;
    private final DBUtils dbUtils;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Fields
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Constructors
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    @Autowired
    protected EventRepository( LogPrinter logPrinter, DataSource dataSource, DBUtils dbUtils )
    {
        this.logPrinter = logPrinter;
        this.dataSource = dataSource;
        this.dbUtils = dbUtils;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Factories
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Getters And Setters
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    public Logger getLogger()
    {
        return LOGGER;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Methods
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    private void eventEntityPeek( EventEntity entity )
    {
        getLogger().debug( entity.toString() );
    }

    private void eventEntityMapper( PreparedStatement ps, EventEntity entity ) throws SQLException
    {
        int counter = 1;
        ps.setString( counter++, entity.getId() );
        ps.setBoolean( counter++, entity.isAlert() );
        ps.setInt( counter++, entity.getDuration() );
        ps.setString( counter++, entity.getType() );
        ps.setString( counter++, entity.getHost() );
    }

    @Override
    public long batchInsert( List< EventEntity > events )
    {
        final String sql = " INSERT INTO DBO.EVENTS ( id, alert, duration, type, host ) "
                + " VALUES ( " + dbUtils.prepareQuestionMarks( 5 ) + " ); "
                ;
        getLogger().info( "inserting: " + events.size() );
        return dbUtils.doBatch( getLogger(), dataSource,
                sql, DBConstants.DB_BATCH_SIZE, events,
                this::eventEntityPeek, this::eventEntityMapper );
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Inner Classes And Patterns
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
